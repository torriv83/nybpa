#file: noinspection YAMLSchemaValidation
name: Deploy Laravel Application

on:
  push:
    branches: [ devtest ]

jobs:
  ci:
    name: âš¡ Rask Deploy CI
    container:
      image: torriv/ci-laravel:php8.4-node22-v2
    env:
      RUNNER_TOOL_CACHE: /toolcache
    outputs:
      composer-hit: ${{ steps.cache-composer.outputs.cache-hit }}
      npm-hit: ${{ steps.cache-npm.outputs.cache-hit }}
      bootstrap-hit: ${{ steps.cache-bootstrap.outputs.cache-hit }}
      public-hit: ${{ steps.cache-public-build.outputs.cache-hit }}
      phpunit-hit: ${{ steps.cache-phpunit.outputs.cache-hit }}
    steps:
      #----------------------------------------
      # CHECKOUT + CACHE
      #----------------------------------------
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ”„ Cache Composer dependencies
        id: cache-composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: ğŸ”„ Cache NPM dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: node_modules
          key: npm-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-

      - name: ğŸ”„ Cache Laravel bootstrap/cache
        id: cache-bootstrap
        uses: actions/cache@v3
        with:
          path: bootstrap/cache
          key: bootstrap-${{ hashFiles('bootstrap/cache/*.php') }}
          restore-keys: bootstrap-

      - name: ğŸ”„ Cache public build assets
        id: cache-public-build
        uses: actions/cache@v3
        with:
          path: public/build
          key: public-build-${{ hashFiles('resources/**/*') }}
          restore-keys: public-build-

      - name: ğŸ”„ Cache PHPUnit result cache
        id: cache-phpunit
        uses: actions/cache@v3
        with:
          path: tests/.phpunit.result.cache
          key: phpunit-${{ hashFiles('phpunit.xml') }}
          restore-keys: phpunit-

      #----------------------------------------
      # INSTALLASJON + BUILD
      #----------------------------------------
      - name: ğŸ“ Install Composer
        run: composer install --no-interaction --optimize-autoloader

      - name: ğŸ“ Install NPM + Build assets
        run: |
          npm ci
          npm run build

      #----------------------------------------
      # OPTIMALISERING
      #----------------------------------------
      - name: âš–ï¸ Laravel optimize + Filament optimize
        run: |
          php artisan optimize
          php artisan filament:optimize

      #----------------------------------------
      # KODEKVALITET
      #----------------------------------------
      - name: ğŸŒŸ Pint (kodeformat)
        run: ./vendor/bin/pint --test

      - name: ğŸ” Larastan (PHPStan)
        run: ./vendor/bin/phpstan analyse --memory-limit -1

      #----------------------------------------
      # TESTING
      #----------------------------------------
      - name: ğŸ” Inject APP_KEY
        run: echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env.testing

      - name: ğŸ§ª Run Laravel Tests
        run: |
          php artisan config:clear
          php artisan test --parallel

      #----------------------------------------
      # DISCORD NOTIFIKASJONER
      #----------------------------------------
      - name: ğŸ“¢ Notify failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{"content":"âŒ CI feilet for *nybpa*. Sjekk loggene!"}' \
               $DISCORD_WEBHOOK
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: ğŸ“¢ Notify success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{"content":"âœ… CI-kjÃ¸ring for *nybpa* fullfÃ¸rt!"}' \
               $DISCORD_WEBHOOK
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

  save-cache:
    name: ğŸ“‚ Save Cache
    needs: ci
    if: always()
    container:
      image: torriv/ci-laravel:php8.4-node22-v2
    steps:
      #----------------------------------------
      # SAVE CACHES (ETTER CI KJÃ˜RING)
      #----------------------------------------
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“‚ Save Composer dependencies
        if: needs.ci.outputs.composer-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: ğŸ“‚ Save NPM dependencies
        if: needs.ci.outputs.npm-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: node_modules
          key: npm-${{ hashFiles('package-lock.json') }}

      - name: ğŸ“‚ Save Laravel bootstrap/cache
        if: needs.ci.outputs.bootstrap-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: bootstrap/cache
          key: bootstrap-${{ hashFiles('bootstrap/cache/*.php') }}

      - name: ğŸ“‚ Save public build assets
        if: needs.ci.outputs.public-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: public/build
          key: public-build-${{ hashFiles('resources/**/*') }}

      - name: ğŸ“‚ Save PHPUnit result cache
        if: needs.ci.outputs.phpunit-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: tests/.phpunit.result.cache
          key: phpunit-${{ hashFiles('phpunit.xml') }}
